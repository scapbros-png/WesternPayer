<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - Western Payer</title>
    <link rel="stylesheet" href="../../styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .payment-section {
            margin-top: 80px;
            padding: 4rem 0;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: calc(100vh - 80px);
        }

        .payment-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .payment-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .payment-header h1 {
            font-size: 3rem;
            font-weight: 800;
            color: #f1f5f9;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 50%, #f472b6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .payment-header p {
            font-size: 1.2rem;
            color: #cbd5e1;
            margin-bottom: 2rem;
        }

        .amount-display {
            background: rgba(30, 41, 59, 0.8);
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(96, 165, 250, 0.2);
            backdrop-filter: blur(10px);
            margin-bottom: 2rem;
            text-align: center;
        }

        .amount-display h3 {
            color: #cbd5e1;
            font-size: 0.9rem;
            margin-bottom: 0.4rem;
            font-weight: 500;
        }

        .amount-display .amount {
            font-size: 2rem;
            font-weight: 700;
            color: #10b981;
            margin: 0.5rem 0;
        }

        .payment-methods {
            background: rgba(30, 41, 59, 0.8);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(96, 165, 250, 0.2);
            backdrop-filter: blur(10px);
            margin-bottom: 2rem;
        }

        .payment-methods h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 2rem;
            text-align: center;
        }

        .payment-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1.5rem;
        }

        .payment-info p {
            color: #60a5fa;
            font-size: 0.9rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .payment-info i {
            color: #fbbf24;
        }

        .secure-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 2rem;
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .secure-badge i {
            color: #10b981;
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .payment-header h1 {
                font-size: 2rem;
            }
            
            .amount-display {
                padding: 1rem;
                margin-bottom: 1.5rem;
            }
            
            .amount-display h3 {
                font-size: 0.85rem;
            }
            
            .amount-display .amount {
                font-size: 1.5rem;
            }
            
            .amount-display p {
                font-size: 0.8rem;
            }
            
            #qrCodeImage {
                width: 240px !important;
                height: 240px !important;
            }
            
            .payment-methods > div:first-of-type {
                padding: 1.5rem !important;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-logo">
                    <img src="../../image/header logo.png" alt="Western Payer" class="logo-img">
                </div>
                <div class="nav-buttons">
                    <a href="../../login.html" class="btn-login" id="loginBtn">Login</a>
                    <div class="wallet-section" id="walletSection" style="display: none;">
                        <div class="wallet-container">
                            <i class="fas fa-wallet"></i>
                            <div class="wallet-info">
                                <span class="wallet-label"></span>
                                <span class="wallet-balance" id="walletBalance">₹0.00</span>
                            </div>
                        </div>
                    </div>
                    <div class="profile-section" id="profileSection" style="display: none;">
                        <div class="profile-dropdown">
                            <button class="profile-btn" id="profileBtn">
                                <i class="fas fa-user-circle"></i>
                            </button>
                            <div class="profile-menu" id="profileMenu">
                                <div class="profile-header">
                                    <i class="fas fa-user-circle"></i>
                                    <span id="userName">User</span>
                                </div>
                                <div class="profile-divider"></div>
                                <a href="../../my-profile.html" class="profile-link">
                                    <i class="fas fa-user"></i>
                                    My Profile
                                </a>
                                <a href="../../settings.html" class="profile-link">
                                    <i class="fas fa-cog"></i>
                                    Settings
                                </a>
                                <a href="../../orders.html" class="profile-link">
                                    <i class="fas fa-shopping-bag"></i>
                                    Orders
                                </a>
                                <div class="profile-divider"></div>
                                <a href="#" class="profile-link logout" id="logoutBtn">
                                    <i class="fas fa-sign-out-alt"></i>
                                    Logout
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Payment Section -->
    <section class="payment-section">
        <div class="payment-container">
            <div class="payment-header">
                <h1>Complete Payment</h1>
                <p>Choose your preferred UPI payment method</p>
            </div>

            <!-- Amount Display -->
            <div class="amount-display">
                <h3>Amount to Pay</h3>
                <div class="amount" id="paymentAmount">₹100</div>
                <p style="color: #94a3b8; font-size: 0.9rem;">Processing Fee</p>
            </div>

            <!-- Payment Methods -->
            <div class="payment-methods">
                <h2>Pay via UPI</h2>
                
                <!-- QR Code Section (Primary Method) -->
                <div style="background: white; padding: 2rem; border-radius: 20px; text-align: center; margin-bottom: 2rem;">
                    <h3 style="color: #1e293b; font-size: 1.5rem; margin-bottom: 1rem; font-weight: 700;">
                        <i class="fas fa-qrcode" style="color: #10b981;"></i> Scan QR Code
                    </h3>
                    <p style="color: #64748b; font-size: 0.95rem; margin-bottom: 0.5rem;">
                        Scan with any UPI app to pay instantly
                    </p>
                    <p style="color: #ef4444; font-size: 0.9rem; margin-bottom: 1.5rem; font-weight: 600;">
                        ⚠️ Important: After scanning, enter the amount shown above: <span id="qrAmount" style="color: #10b981;">₹100</span>
                    </p>
                    
                    <!-- QR Code Image -->
                    <div style="background: white; padding: 1rem; border-radius: 15px; display: inline-block; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
                        <img id="qrCodeImage" src="../../image/qr code.jpg" alt="UPI QR Code" style="width: 280px; height: 280px; display: block; object-fit: contain;">
                    </div>
                    
                    <!-- Supported Apps -->
                    <div style="margin-top: 1.5rem; display: flex; justify-content: center; align-items: center; gap: 1rem; flex-wrap: wrap;">
                        <span style="color: #64748b; font-size: 0.9rem;">Supported Apps:</span>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/2/24/Paytm_Logo_%28standalone%29.svg" alt="Paytm" style="height: 24px;">
                            <img src="https://cdn.brandfetch.io/idcE0OdG8i/theme/dark/symbol.svg?c=1dxbfHSJFAPEGdCLU4o5B" alt="PhonePe" style="height: 24px;">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/f/f2/Google_Pay_Logo.svg" alt="Google Pay" style="height: 24px;">
                        </div>
                    </div>
                </div>

                <!-- Manual Payment Details -->
                <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 1.5rem; margin-top: 1.5rem;">
                    <h3 style="color: #60a5fa; font-size: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-mobile-alt"></i> Manual Payment (if QR doesn't work)
                    </h3>
                    <div style="background: rgba(15, 23, 42, 0.8); padding: 1rem; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <span style="color: #cbd5e1; font-size: 0.9rem;"><strong>UPI ID:</strong></span>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: #60a5fa; user-select: all; font-family: monospace;" id="upiIdText">Q459630347@ybl</span>
                                <button onclick="copyUPIId()" style="background: #10b981; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                        <p style="color: #cbd5e1; font-size: 0.9rem; margin-bottom: 0.5rem;">
                            <strong>Name:</strong> <span style="color: #94a3b8;">Suraj Kumar (Staff of Western Payer)</span>
                        </p>
                        <p style="color: #cbd5e1; font-size: 0.9rem; margin-bottom: 0.5rem;">
                            <strong>Amount:</strong> <span style="color: #10b981; font-weight: 700;" id="manualAmount">₹100</span>
                        </p>
                        <p style="color: #fbbf24; font-size: 0.85rem; margin-top: 0.75rem; display: flex; align-items: start; gap: 0.5rem;">
                            <i class="fas fa-info-circle" style="margin-top: 2px;"></i>
                            <span>Open any UPI app, select "Send Money", paste the UPI ID above, and enter the exact amount.</span>
                        </p>
                    </div>
                </div>

                <!-- Transaction ID Section -->
                <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 1.5rem; margin-top: 1.5rem;">
                    <h3 style="color: #10b981; font-size: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-check-circle"></i> Submit Transaction Details
                    </h3>
                    <p style="color: #cbd5e1; font-size: 0.9rem; margin-bottom: 1rem;">
                        After completing the payment, enter your transaction ID below to confirm your payment.
                    </p>
                    <form id="transactionForm">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; color: #cbd5e1; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                Transaction ID / UTR Number <span style="color: #ef4444;">*</span>
                            </label>
                            <input 
                                type="text" 
                                id="transactionId" 
                                name="transactionId"
                                placeholder="Enter 12-digit transaction ID (e.g., 123456789012)"
                                style="width: 100%; padding: 0.75rem; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; background: rgba(15, 23, 42, 0.8); color: #f1f5f9; font-size: 0.95rem; transition: all 0.3s ease;"
                                required
                            />
                            <small style="color: #94a3b8; font-size: 0.8rem; margin-top: 0.25rem; display: block;">
                                Find this in your UPI app under transaction history
                            </small>
                        </div>
                        
                        <button 
                            type="submit" 
                            id="submitBtn"
                            style="width: 100%; background: #000000; color: white; border: 1px solid rgba(255, 255, 255, 0.2); padding: 0.875rem 1.5rem; border-radius: 10px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 15px 35px rgba(0, 0, 0, 0.5)'; this.style.background='#1a1a1a'; this.style.borderColor='rgba(255, 255, 255, 0.3)';"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 25px rgba(0, 0, 0, 0.3)'; this.style.background='#000000'; this.style.borderColor='rgba(255, 255, 255, 0.2)';"
                        >
                            <i class="fas fa-paper-plane"></i> Submit Transaction ID
                        </button>
                    </form>
                    
                    <!-- Success Message (hidden by default) -->
                    <div id="successMessage" style="display: none; background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.5); border-radius: 8px; padding: 1rem; margin-top: 1rem;">
                        <p style="color: #10b981; font-size: 0.9rem; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-check-circle"></i> 
                            <strong>Transaction ID submitted successfully!</strong>
                        </p>
                        <p style="color: #cbd5e1; font-size: 0.85rem; margin: 0.5rem 0 0 1.75rem;">
                            We will verify your payment and process your withdrawal shortly.
                        </p>
                    </div>
                </div>
            </div>

            <div class="secure-badge">
                <i class="fas fa-shield-alt"></i>
                <span>100% Secure Payment</span>
            </div>
        </div>
    </section>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="../../firebase-config.js"></script>
    
    <!-- Optimized Wallet Balance Loader -->
    <script src="../../wallet-balance-loader.js"></script>
    <script src="../../charges-calculator.js"></script>
    
    <script>
        // Copy UPI ID function
        function copyUPIId() {
            const upiId = 'Q459630347@ybl';
            navigator.clipboard.writeText(upiId).then(() => {
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                btn.style.background = '#10b981';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('UPI ID: ' + upiId);
            });
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // Get amount and payment type from URL
            const urlParams = new URLSearchParams(window.location.search);
            const amount = urlParams.get('amount') || '100';
            const paymentType = urlParams.get('type') || '';
            const cleanAmount = amount.toString().replace(/,/g, '');
            
            // Update page title if it's a wallet add transaction
            if (paymentType === 'wallet_add') {
                const pageTitle = document.querySelector('.payment-header h1');
                const pageDesc = document.querySelector('.payment-header p');
                if (pageTitle) pageTitle.textContent = 'Add Money to Wallet';
                if (pageDesc) pageDesc.textContent = 'Complete your wallet top-up transaction';
            }
            
            // Update all amount displays
            document.getElementById('paymentAmount').textContent = '₹' + parseFloat(cleanAmount).toLocaleString();
            document.getElementById('manualAmount').textContent = '₹' + parseFloat(cleanAmount).toLocaleString();
            document.getElementById('qrAmount').textContent = '₹' + parseFloat(cleanAmount).toLocaleString();

            // Login/Profile/Wallet functionality
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            const loginBtn = document.getElementById('loginBtn');
            const profileSection = document.getElementById('profileSection');
            const walletSection = document.getElementById('walletSection');
            const walletBalance = document.getElementById('walletBalance');
            const userName = document.getElementById('userName');
            const profileBtn = document.getElementById('profileBtn');
            const profileMenu = document.getElementById('profileMenu');
            const logoutBtn = document.getElementById('logoutBtn');
            
            if (userData.isLoggedIn && userData.uid) {
                loginBtn.style.display = 'none';
                profileSection.style.display = 'block';
                walletSection.style.display = 'block';
                userName.textContent = userData.name || 'User';
                
                // Display wallet balance from Firebase
                try {
                    const walletData = await dbHelper.getUserWallet(userData.uid);
                    const balance = walletData.balance || 0;
                    walletBalance.textContent = '₹' + parseFloat(balance).toLocaleString('en-IN', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                } catch (error) {
                    console.error('Error loading wallet balance:', error);
                }
            }
            
            // Wallet click functionality - navigate to wallet page
            const walletContainer = document.querySelector('.wallet-container');
            if (walletContainer) {
                walletContainer.addEventListener('click', function() {
                    window.location.href = '../../wallet.html';
                });
            }
            
            if (profileBtn) {
                profileBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    profileBtn.parentElement.classList.toggle('active');
                });
            }
            
            document.addEventListener('click', function(e) {
                if (profileBtn && profileMenu) {
                    if (!profileBtn.contains(e.target) && !profileMenu.contains(e.target)) {
                        profileBtn.parentElement.classList.remove('active');
                    }
                }
            });
            
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    try {
                        await firebaseAuth.signOut();
                        localStorage.removeItem('userData');
                        profileSection.style.display = 'none';
                        walletSection.style.display = 'none';
                        loginBtn.style.display = 'inline-block';
                        profileBtn.parentElement.classList.remove('active');
                    } catch (error) {
                        console.error('Error signing out:', error);
                        alert('Error signing out. Please try again.');
                    }
                });
            }

            // Transaction Form Submission
            const transactionForm = document.getElementById('transactionForm');
            const transactionIdInput = document.getElementById('transactionId');
            const submitBtn = document.getElementById('submitBtn');
            const successMessage = document.getElementById('successMessage');

            // Add input focus styling
            transactionIdInput.addEventListener('focus', function() {
                this.style.borderColor = '#60a5fa';
                this.style.boxShadow = '0 0 0 3px rgba(96, 165, 250, 0.1)';
            });

            transactionIdInput.addEventListener('blur', function() {
                this.style.borderColor = 'rgba(96, 165, 250, 0.3)';
                this.style.boxShadow = 'none';
            });

            // Handle form submission
            transactionForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const transactionId = transactionIdInput.value.trim();

                // Basic validation
                if (!transactionId) {
                    transactionIdInput.style.borderColor = '#ef4444';
                    return;
                }

                if (transactionId.length < 10) {
                    transactionIdInput.style.borderColor = '#ef4444';
                    alert('Please enter a valid transaction ID (minimum 10 characters)');
                    return;
                }

                // Show loading state
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
                submitBtn.style.opacity = '0.7';
                submitBtn.style.cursor = 'not-allowed';

                // Get payment details
                const paymentData = {
                    transactionId: transactionId,
                    amount: cleanAmount,
                    upiId: 'Q459630347@ybl',
                    merchantName: 'Suraj Kumar',
                    paymentType: paymentType,
                    status: paymentType === 'wallet_add' ? 'pending' : 'completed'
                };

                console.log('Transaction submitted:', paymentData);

                // Simulate API call and store in Firebase
                setTimeout(async () => {
                    try {
                        if (userData.uid) {
                            // Store transaction/payment request in Firebase
                            const requestRef = firebaseDb.ref('users/' + userData.uid + '/paymentRequests').push();
                            await requestRef.set({
                                ...paymentData,
                                id: requestRef.key,
                                timestamp: firebase.database.ServerValue.TIMESTAMP
                            });
                            
                            // Create order for tracking
                            const orderData = {
                                productName: paymentType === 'wallet_add' ? 'Wallet Top-up' : 'Payment Transaction',
                                amount: cleanAmount,
                                customerName: userData.name || 'User',
                                customerEmail: userData.email || 'N/A',
                                paymentMethod: 'UPI',
                                transactionId: transactionId
                            };
                            
                            const orderResult = await dbHelper.addOrder(userData.uid, orderData);
                            console.log('Order created:', orderResult);
                        }

                        // Hide form
                        transactionForm.style.display = 'none';
                        
                        // Show success message
                        successMessage.style.display = 'block';

                        // Reset button (in case form is shown again)
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Transaction ID';
                        submitBtn.style.opacity = '1';
                        submitBtn.style.cursor = 'pointer';

                        // Scroll to success message
                        successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });

                        // If this is a wallet add transaction, show pending message
                        if (paymentType === 'wallet_add') {
                            // Update success message for wallet add
                            const successMsg = document.querySelector('#successMessage h2');
                            if (successMsg) {
                                successMsg.textContent = 'Wallet Top-up Request Submitted!';
                            }
                            const successDesc = document.querySelector('#successMessage p');
                            if (successDesc) {
                                const addAmount = parseFloat(cleanAmount);
                                successDesc.textContent = `Your request to add ₹${addAmount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} has been submitted. It will be reviewed by admin and added to your wallet once approved. Redirecting to wallet page...`;
                            }
                            
                            // Redirect to wallet page after 5 seconds
                            setTimeout(() => {
                                window.location.href = '../../wallet.html';
                            }, 5000);
                        }
                    } catch (error) {
                        console.error('Error submitting payment:', error);
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Transaction ID';
                        submitBtn.style.opacity = '1';
                        submitBtn.style.cursor = 'pointer';
                        alert('Error submitting transaction. Please try again.');
                    }
                }, 1500);
            });
        });
    </script>
</body>
</html>

